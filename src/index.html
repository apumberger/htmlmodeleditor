<!DOCTYPE html>
<!--
ModelEditor
Version 0.2
Author: Andreas Pumberger

TODO:
* make node names editable
* make labels editable
* save JSON to Server
* load JSON from Server

* fix workaround with maxtop
* fix focus for node name

-->
<html>
<head>
	<title>ModelEditor v0.2</title>

    <link rel="stylesheet" href="http://www.jointjs.com/downloads/joint.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://www.jointjs.com/js/vendor/lodash/lodash.min.js"></script>
    <script src="http://www.jointjs.com/js/vendor/backbone/backbone-min.js"></script>
    <script src="http://www.jointjs.com/downloads/joint.js"></script>
    <script src='js/bootstrap.min.js'></script>
</head>
<body>

<!-- Bootstrap Modals -->
<!-- About -->

<div id='aboutModal' class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">About</h4>
      </div>
      <div class="modal-body">
        <p>ModelEditor v0.2</p>
        <ul>Functionality:
        <li>changed framework to jointjs</li>
        <li>add nodes with node names</li>
        <li>make sure new node doesn't overlay with previously created node</li>
        <li>create message between nodes (from to)</li>
        <li>move nodes and have message following node position changes</li>
        <li>label and arrow for messages</li>
        <li>clear model</li>
        </ul>
        <p>created by: Andreas Pumberger</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Node Dialoge -->

<div id="newNodeModal" class="modal fade">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!--form-->
            <form class = "form-horizontal" id="nodeform" method="post" action="javascript:newNode()" role="form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">New/Edit Node</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Please enter the node name.
                    </p>
                    <br/>

                    <div class="form-group">

                        <div class="col-lg-12">
                            <label class="control-label" for="nodename">Name</label>
                            <input type="text" class="form-control required" id="nodename" name="nodename" autofocus></input>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="myFormSubmit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Message Dialoge -->

<div id="newMessageModal" class="modal fade">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!--form-->
            <form class = "form-horizontal" id="messageform" method="post" action="javascript:newMessage()" role="form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">New/Edit Message</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Please enter the from- and to-node names and label
                    </p>
                    <br/>

                    <div class="form-group">

                        <div class="col-lg-12">
                            <label class="control-label" for="fromnode">From Node:</label>
                            <select id="fromnode"></select>
                            <label class="control-label" for="tonode">To Node:</label>
                			<select id="tonode"></select>
                        </div>
                         <div class="col-lg-12">
                            <label class="control-label" for="label">Label</label>
                            <input type="text" class="form-control required" id="label" name="label">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="myFormSubmit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap navbar -->
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">ModelEditor v0.2</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href='javascript:newNodeDialoge()'>New Node</a></li>
        <li><a href='javascript:newMessageDialoge()'>New Message</a></li> 
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More<span class="caret"></span></a>
          <ul class="dropdown-menu">
<!--
            <li><a href="#">Action</a></li>
            <li role="separator" class="divider"></li>
-->
            <li><a href="javascript:clearGraph()">Clear Canvas</a></li>
          </ul>
        </li>
         <li><a href='javascript:about()'>About?</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<!-- end Bootstrap navbar -->

<!-- id for Model -->
<div id="myModel"></div>

	<script type="text/javascript">

	    $('#newNodeModal').on('show.bs.modal', function () {
   			 $('#nodename').focus();
		})

		var bNewNode = true;
		var bNewMessage = true;

		var maxTop = 10;
		
		var graph = new joint.dia.Graph;

	   	var paper = new joint.dia.Paper({
	        el: $('#myModel'),
	        width: 800,
	        height: 400,
	        model: graph,
	        gridSize: 1
    	});

    	var model = {model : myModel, nodes:[],links:{}};




		function newNodeDialoge () {
	      bNewNode = true;

	      $('#newNodeModal').modal('show');
	      $('#nodename').focus();

	      //document.getElementById("nodename").focus();
    	}

    	function newNode () {
	      //make X and Y coordinates center
	      // fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';


	      console.log('Enter newNode method');
	      console.log(bNewNode);
	      var nodeName = null;
	      nodeName = $('#nodename').val();
	      console.log('Name ', nodeName);

	      $("#newNodeModal").modal('hide'); //hide popup  
	      $('#nodename').val('');

	      if (bNewNode) {
	      	console.log('in new node branch');

	        if (maxTop == 0) {
	          maxTop = 10;
	        }
	        else {
	          maxTop = maxTop + 70;
	        }

	    	var rect = new joint.shapes.basic.Rect({
	        	position: { x: 100, y: maxTop },
	        	size: { width: 100, height: 30 },
	        	attrs: { rect: { fill: 'blue' }, text: { text: nodeName, fill: 'white' } }
	    	});

	    	// handle event for change position of nodes

	    	rect.on('change:position', function(element) {
    			console.log(element.id, ':', element.get('position'));
			});

			//

	    	console.log('add node');

	    	// add Node to JSON model
	    	var nodes = model.nodes;
	    	nodeID = rect.id;
	    	var item = {"nodeID" : nodeID, "nodeName" : nodeName, "position" : {x : maxTop, y : 30}};
	    	nodes.push(item);
	    	$.extend(model.nodes,nodes);
	    	
	    	console.log(model);
	        graph.addCells([rect]);
	      }
	      else {
	      	console.log('not new node');
	/*
	         var activeObject = canvas.getActiveObject();
	         var objectsInGroup = activeObject.getObjects();
	          objectsInGroup.forEach(function(object) {
	          var oText = object.text;
	          if (oText) {
	            object.set({text: nodeName});
	          }
	         });
	*/
	      }

	  }

	   function newMessageDialoge() {
	      console.log('newMessageDIaloge');

	      getNodeNames('tonode');
	      getNodeNames('fromnode');

	      $('#newMessageModal').modal('show');
	    }

	    function newMessage() {
	    	console.log('NewMessage');

	    	var fromNode = $('#fromnode').val();
	      	console.log('FromNode: ', fromNode);

	      	var toNode = $('#tonode').val();
	      	console.log('ToNode: ', toNode);

	      	var label = $('#label').val();
	      	console.log('label: ', label);


	      	var link = new joint.dia.Link({
    		source: { id: fromNode },
    		target: { id: toNode },
    		attrs: {
//        		'.marker-source': { fill: 'red', stroke: 'black', d: 'M 10 0 L 0 5 L 10 10 z'},
        		'.marker-target': { fill: 'yellow', stroke: 'black', d: 'M 10 0 L 0 5 L 10 10 z' }
    		},
    		labels: [
        		{ position: 0.5, attrs: { text: { text: label } } }
   			 ]
    		});

	      	graph.addCells([link]);

    		//

    		$("#newMessageModal").modal('hide'); //hide popup  
    		$('#label').val('');

	    }

	    function clearGraph() {
	      graph.clear();
	    }


		function about () {
			$('#aboutModal').modal('show');
	    }

//================== HELPER FUNCTIONS

		function getNodeNames (referenceName) {
			console.log('in getNodeNames for ' + referenceName);

			removeOptions(referenceName);

			var data = model.nodes;
		    var element = document.getElementById(referenceName);



			for (i=0; i < data.length; i++) {
				var opt = document.createElement('option');
    			opt.innerHTML = data[i].nodeName;
    			opt.value = data[i].nodeID;
    			console.log(data[i].nodeID);
    			element.appendChild(opt);
			}
		}

		function removeOptions(referenceName)
		{
    		var i;
    		var element = document.getElementById(referenceName);
    		for(i=element.options.length-1;i>=0;i--)
    		{
        		element.remove(i);
    		}
		}

	</script>
</body>

